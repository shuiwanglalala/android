# Android全面解析之Window机制

https://juejin.cn/post/6888688477714841608#heading-22

## 什么是window?

在Android的window机制中，每个view树都可以看成一个window。为什么不是每个view呢？因为view树中每个view的显示次序是固定的，例如我们的Activity布局，每一个控件的显示都是已经安排好的，对于window机制来说，属于“不可再分割的view”

- view是window的存在形式，window是view的载体
- window是view的管理者，同时也是view的载体。他是一个抽象的概念，本身并不存在，view是window的表现形式

## Window的添加过程

**整个应用的所有viewRootImpl的windowSession都是同一个，也就是一个应用只有一个windowSession**。对于wms而言，他是服务于多个应用的，如果说每个viewRootImpl整一个session，那他的任务就太重了。WMS的对象单位是应用，他**在内部给每个应用session分配了一些数据结构如list，用于保存每个应用的window以及对应的viewRootImpl**。当需要操作view的时候，通过session直接找到viewRootImpl就可以操作了

window的添加过程是通过PhoneWindow对应的WindowManagerImpl来添加window，内部会调用WindowManagerGlobal来实现。WindowManagerGlobal会使用viewRootImpl来进行跨进程通信让WMS执行创建window的业务

每个应用都有一个windowSession，用于负责和WMS的通信，如ApplicationThread与AMS的通信

## window与PhoneWindow的关系

PhoneWindow是一个top-level window（顶级窗口），他被添加到顶级窗口管理器的顶层视图，其他的window，都需要添加到这个顶层视图中，所以更准确的来说，**PhoneWindow并不是view容器，而是window容器**

那PhoneWindow的存在意义是什么？

+ 提供DecorView模板

+ 抽离Activity中关于window的逻辑

  事实上，Activity调用的是WindowManagerImpl，但因PhoneWindow和WindowManagerImpl两者是成对存在，他们共同处理window相关的事务，所以这里就简单写成交给PhoneWindow处理

+ 限制组件添加window的权限

  PhoneWindow内部有一个token属性，用于验证一个PhoneWindow是否允许添加window。在Activity创建PhoneWindow的时候，就会把从AMS传过来的token赋值给他，从而他也就有了添加token的权限。而其他的PhoneWindow则没有这个权限，因而也无法添加window

PhoneWindow本身不是真正意义上的window，他更多可以认为是辅助Activity操作window的工具类

windowManagerImpl并不是管理window的类，而是管理PhoneWindow的类。真正管理window的是WMS

PhoneWindow可以配合DecorView可以给其中的window按照一定的逻辑提供标准的UI策略

PhoneWindow限制了不同的组件添加window的权限

## 常见组件的window创建流程

因而有两种创建window的方式：

- 已经存在PhoneWindow，直接通过WindowManagerImpl创建window
- PhoneWindow尚未存在，先创建PhoneWindow，再利用windowManagerImpl来创建window

### Activity

从Activity的启动流程可以得到Activity创建Window的过程

创建PhoneWindow -> 创建WindowManager -> 创建decorView -> 利用windowManager把DecorView显示到屏幕上

回调onResume方法的时候，DecorView还没有被添加到屏幕，所以当onResume被回调，指的是屏幕即将到显示，而不是已经显示

### PopupWindow

popupWindow是依附于activity而存在的，当Activity未运行时，是无法弹出popupWindow的，通过源码可以知道，当调用onResume方法的时候，其实后续还有很多事情在做，这个时候Activity也是尚未完全启动，所以popupWindow不能在onCreate、onStart、onResume方法中弹出

### Dialog

dialog和popupWindow不同，dialog创建了新的PhoneWindow，使用了PhoneWindow的DecorView模板。而popupWindow没有

dialog的显示层级数更高，会直接显示在Activity上面，在dialog后添加的popUpWindow也会显示在dialog下

dialog的创建流程和activity非常像

## 从Android架构角度看Window