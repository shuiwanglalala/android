# 传输层

+ 传输层概述
  + 功能 
    + 提供进程和进程之间的逻辑通信
    + 复用和分用
    + 对收到的报文进行差错检测
  + 端口 长度2B
    + 服务端
        + 熟知端口 0-1023
            + ftp=tcp+21
            + telnet=tcp+23
            + smtp=tcp+25
            + dns=udp+53
            + tftp 69
            + http= tcp+80
            + pop3=tcp+110
            + snmp 161
        + 登记端口 1024-49151
  + 客户端 49152-65535 仅在客户进程运行时才动态选择
    
+ 套接字=（主机IP地址，端口号）
  
+ UDP
  + 特点
    + 无连接，减少开销和发送数据之前的时延
    + 使用最大努力交付，即不保证可靠交付
    + 面向报文的，适合一次性传输少量数据的网络应用。应用层给UDP多长的报文，UDP就照样发送，即一次发送一个完整报文
    + 无拥塞控制，适合很多实时应用
    + UDP首部开销小，8B，TCP是20B
+ TCP
  + 特点
    + 面向连接的传输层协议
    + 每一个TCP只能有两个端点，只能用于点对点连接，无法用于广播和多播
    + 可靠交付，无差错，不丢失，不重复，按序到达
    + 提供全双工通信
    + 面向字节流
  + 连接管理
    + TCP连接的建立
      + 客户端发送连接请求报文段，无应用层数据 SYN=1，seq=x(随机)
      + 服务器端为该TCP连接分配缓存和变量，并向客户端返回确认报文段，允许连接，无应用层数据SYN=1，ACK=1，ack=x+1，seq=y(随机)
      + 客户端为该TCP连接分配缓存和变量，并向服务器返回确认的确认，可以携带数据 SYN=0，ACK=1，ack=y+1，seq=x+1
    + TCP连接的释放
      + 客户端发送连接释放报文段，停止发送数据，主动关闭TCP连接 FIN=1，seq=u
      + 服务器端回送一个确认报文段，客户到服务器这个方向的连接就释放了——半关闭状态 ACK=1，seq=v，ack=u+1
      + 服务器端发完数据，就发出连接释放报文段，主动关闭TCP连接 FIN=1，ACK=1，ack=u+1，seq=w
      + 客户端回送一个确认报文段，再等到时间等待计时器设置的2MSL(最长报文段寿命)后，连接彻底关闭 ACK=1，ack=w+1，seq=u+1
    + TCP可靠传输
      + 校验 与UDP校验一样，增加伪首部
      + 序号
      + 确认
      + 重传 TCP的发送方在规定的时间内没有收到确认就要重传已发送的报文段
    + TCP流量控制 
      + 接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，即接收窗口rwnd（接收方设置确认报文段的窗口字段来将rwnd通知给发送方），发送方的发送窗口=min（接收窗口rwnd，拥塞窗口cwnd）
      + TCP为每一个连接设有一个持续计时器，只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发送一个零窗口探测报文段。接收方收到探测报文段时给出现在的窗口值。若窗口值为0，则发送方重新设置持续计时器
    + TCP拥塞控制
      + 慢开始和拥塞避免
      + 快重传和快恢复 TCP Reno



TCP报文段

固定部分 20B

| 源端口 | 目的端口 | 序号 | 确认号 | 数据偏移 | 保留 | URG  | ACK  | PSH  | RST  | SYN  | FIN  | 窗口 | 检验和 | 紧急指针 | 选项 | 填充 |
| ------ | -------- | ---- | ------ | -------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ------ | -------- | ---- | ---- |
| 2      | 2        | 4    | 4      | 0.5      |      | 1bit | 1bit | 1bit | 1bit | 1bit | 1bit | 2    | 2      | 2        |      |      |
|        |          |      |        | 单位4B   |      |      |      |      |      |      |      |      |        |          |      |      |
|        |          |      |        |          |      | 紧急 | 确认 | 推送 | 复位 | 同步 | 终止 |      |        |          |      |      |

+ 序号 本报文段所发送数据的第一个字节的序号
+ 确认号 期望收到对方下一个报文段的第一个字节的序号。若序号是N，则证明序号N-1为止的所有数据都已正确收到
+ 数据偏移 其实就是TCP首部长度
+ 窗口 发送本报文段的一方的接收窗口，即现在允许对方发送的数据量