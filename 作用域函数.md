# 作用域函数

[[译]掌握Kotlin中的标准库函数: run、with、let、also和apply](https://zhuanlan.zhihu.com/p/37085876)

## 区别

由于作用域函数本质上都非常相似，因此了解它们之间的区别很重要。每个作用域函数之间有两个主要区别：

- 引用上下文对象的方式
- 返回值

### 上下文对象：`this` 还是 `it`

## 几个函数

### `let`

**上下文对象**作为 lambda 表达式的参数（`it`）来访问。**返回值**是 lambda 表达式的结果

若代码块仅包含以 `it` 作为参数的单个函数，则可以使用方法引用(`::`)代替 lambda 表达式

`let` 经常用于仅使用非空值执行代码块。如需对可空对象执行操作，可对其使用安全调用操作符 `?.` 并调用 `let` 在 lambda 表达式中执行操作

### `with`

一个非扩展函数：**上下文对象**作为参数传递，但是在 lambda 表达式内部，它可以作为接收者（`this`）使用。 **返回值**是 lambda 表达式结果

### `run`

**上下文对象** 作为接收者（`this`）来访问。 **返回值** 是 lambda 表达式结果

`run` 和 `with` 做同样的事情，但是调用方式和 `let` 一样——作为上下文对象的扩展函数

除了在接收者对象上调用 `run` 之外，还可以将其用作非扩展函数。 非扩展 `run` 可以使你在需要表达式的地方执行一个由多个语句组成的块

### `apply`

**上下文对象** 作为接收者（`this`）来访问。 **返回值** 是上下文对象本身

### `also`

**上下文对象**作为 lambda 表达式的参数（`it`）来访问。 **返回值**是上下文对象本身

## 函数选择

| 函数    | 对象引用 | 返回值            | 是否是扩展函数             |
| :------ | :------- | :---------------- | :------------------------- |
| `let`   | `it`     | Lambda 表达式结果 | 是                         |
| `run`   | `this`   | Lambda 表达式结果 | 是                         |
| `run`   | -        | Lambda 表达式结果 | 不是：调用无需上下文对象   |
| `with`  | `this`   | Lambda 表达式结果 | 不是：把上下文对象当做参数 |
| `apply` | `this`   | 上下文对象        | 是                         |
| `also`  | `it`     | 上下文对象        | 是                         |

## `takeIf` 与 `takeUnless`

当以提供的谓词在对象上进行调用时，若该对象与谓词匹配，则 `takeIf` 返回此对象。否则返回 `null`。因此，`takeIf` 是单个对象的过滤函数。反之，`takeUnless`如果不匹配谓词，则返回对象，如果匹配则返回 `null`。该对象作为 lambda 表达式参数（`it`）来访问

当在 `takeIf` 及 `takeUnless` 之后链式调用其他函数，不要忘记执行空检查或安全调用（`?.`），因为他们的返回值是可为空的