# 使用存储访问框架打开文件

Android 4.4（API 级别 19）引入了存储访问框架 (SAF)。借助 SAF，用户可轻松浏览和打开各种文档、图片及其他文件，而不用管这些文件来自其首选文档存储提供程序中的哪一个。用户可通过易用的标准界面，跨所有应用和提供程序以统一的方式浏览文件并访问最近用过的文件

云存储服务或本地存储服务可实现用于封装其服务的 `DocumentsProvider`，从而加入此生态系统

SAF 包含以下元素

- **文档提供程序** - 一种内容提供程序，可让存储服务（如 Google 云端硬盘）提供其管理的文件。文档提供程序以 `DocumentsProvider` 类的子类形式实现。文档提供程序的架构基于传统的文件层次结构，但其实际的数据存储方式由您决定。Android 平台包含若干内置的文档提供程序，如 Downloads、Images 和 Videos
- **客户端应用** - 一种定制化的应用，它会调用 `ACTION_CREATE_DOCUMENT`、`ACTION_OPEN_DOCUMENT` 和 `ACTION_OPEN_DOCUMENT_TREE` intent 操作并接收文档提供程序返回的文件
- **选择器** - 一种系统界面，可让用户访问所有文档提供程序内满足客户端应用搜索条件的文档

## 控制流

- 在 SAF 中，提供程序和客户端并不直接交互。客户端会请求与文件进行交互（即读取、修改、创建或删除文件）的权限
- 当应用触发 `ACTION_OPEN_DOCUMENT` 或 `ACTION_CREATE_DOCUMENT` intent 后，交互便会开始。intent 可包含过滤器，用于进一步细化条件，例如“为我提供所有 MIME 类型为‘图片’”的可打开文件”
- 当 intent 触发后，系统选择器会联络每个已注册的提供程序，并向用户显示匹配内容的根目录
- 选择器会为用户提供标准的文档访问界面，即使底层的文档提供程序可能相互之间差异很大，一致性也不受影响

## 编写客户端应用

在 Android 4.3 及更低版本中，如果您想让应用从其他应用中检索文件，则该应用必须调用 `ACTION_PICK` 或 `ACTION_GET_CONTENT` 等 intent。然后，用户必须选择一个要从中选取文件的应用，并且所选应用必须提供用户界面，以便用户浏览和选择可用文件

在 Android 4.4（API 级别 19）及更高版本中，您还可选择使用 `ACTION_OPEN_DOCUMENT` intent，此 intent 会显示由系统控制的选择器界面，以便用户浏览其他应用提供的所有文件。借助此界面，用户便可从任何受支持的应用中选择文件

在 Android 5.0（API 级别 21）及更高版本中，您还可以使用 `ACTION_OPEN_DOCUMENT_TREE` intent，借助此 intent，用户可以选择供客户端应用访问的目录

**注意**：`ACTION_OPEN_DOCUMENT` 并非用于替代 `ACTION_GET_CONTENT`。您应使用的 intent 取决于应用的需要

- 如果您只想让应用读取/导入数据，请使用 `ACTION_GET_CONTENT`。使用此方法时，应用会导入数据（如图片文件）的副本
- 如果您想让应用获得对文档提供程序所拥有文档的长期、持续访问权限，请使用 `ACTION_OPEN_DOCUMENT`。例如，照片编辑应用可让用户编辑存储在文档提供程序中的图片





https://github.com/android/storage-samples/tree/main/StorageClient