# 数据链路层

+ 数据链路层功能概述
  + 加强物理层传输原始比特流的能力，将物理层提供的可能出错的网络连接改造成逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路
    + 为网络层提供服务
      + 无确认无连接服务
      + 有确认无连接服务
      + 有确认面向连接服务
    + 链路管理，即连接的建立、维持、释放（用于面向连接的服务）
    + 组帧
    + 流量控制
    + 差错控制（帧错/位错）
+ 封装成帧 透明传输
  + 封装成帧
    + 字符计数法 帧首部使用一个计数字段（第一个字节，八位）来表明帧内字符数
    + 字符填充法 SOH EOT
      + 当传送的帧是文本文件组成时（文本文件的字符都是从键盘上输入，都是ASCII码），不管从键盘上输入什么字符都可以放在帧里传过去，即透明传输
      + 当传送的帧由非ASCII码组成时，就要采用字符填充法实现透明传输
    + 零比特填充法 51 10 晕倒连续5个1，就插入一个0
    + 违规编码法 用“高高”、“低低”定义帧的起始和结束
  + 透明传输
  + 帧同步：接收方应当能从收到二进制比特流中区分出帧的起始和终止
+ 差错控制
  + 差错
    + 位错
    + 帧错 丢失 重复 失序
  + 检错编码
    + 奇偶校验码
    + 循环冗余码CRC
      + 最终发送的数据=要发送的数据+帧检验序列FCS
      + 先加0（生产多项式的阶数），再异或（同0异1）
  + 纠错编码
    + 海明码 发现双比特错，纠正单比特错
      + 确定校验码位数r  2[r]>=k+r+1
      + 确定校验码和数据的位置 校验码只能放在2的几次方位置

+ 流量控制与可靠传输机制
  + 与传输层流量控制的区别
    + 数据链路层的流量控制时点对点的，而传输层的流量控制是端到端的
    + 数据链路层流量控制手段是接收方收不下就不回复确认，而传输层流量控制手段是接收端给发送端一个窗口公告
  + 流量控制的方法
    + 停止-等待协议 每发完一个帧就停止发送，等待对方的确认，在收到确认后再发送下一个帧
      + 发送窗口大小=1，接收窗口大小=1
    + 滑动窗口协议
      + 后退N帧协议 GBN
        + (用n个bite对帧编号) 2[n]-1>=发送窗口大小>=1，接收窗口大小=1
        + GBN发送方必须响应的三件事
          + 上层的调用
          + 收到一个ACK 对n号帧的确认采用累计确认，标明接收方已经收到n号帧和它之前的全部帧
          + 超时事件 如果发送超时，发送方会重传所有已发送但未被确认的帧
        + GBN接收方要做的事
          + 如果正确收到n号帧，并且按序，则接收方为n帧发送一个ACK，并将帧内数据交付上层
          + 其他情况都丢弃帧，并为最近按序收到的帧重发ACK。接收方无需缓存任何帧，只需要维护一个信息expectedseqnum(下一个按序接收的帧序号)
      + 选择重传协议 SR
        + (用n个bite对帧编号)2[n-1]>=发送窗口大小>1，2[n-1]>=接收窗口大小>1
          + 发送窗口最好等于接收窗口
        + SR发送方必须响应的三件事
          + 上层的调用
          + 收到一个ACK，则将被确认的帧标记为已接收。如果该帧序号是窗口的下界（最左边第一个窗口的序号），则窗口向前移动到具有最小序号的未确认帧处。如果窗口移动了且有序号在窗口内的未发送帧，则发送这些帧
          + 超时事件 如果发送超时，发送方只会重传一个帧
        + SR接收方要做的事
          + 对于窗口内的帧，接收方将确认一个正确接收的帧而不管其是否按序。失序的帧将被缓存，并且返回给发送方一个该帧的ACK（收谁确认谁），直到所有帧（即序号更小的帧）皆被收到为止，这时才可以将这一批帧上传，并向前移动窗口
          + 收到了窗口序号外（小于窗口下界）的帧，返回一个ASK
          + 其他情况则忽略

+ 信道划分 介质访问控制
  + 数据链路层使用的信道类型
    + 点对点信道
      + PPP协议 面向字节 无序号和无确认机制，所以不可靠
        + 只支持全双工
      + HDLC协议 面向比特 有序号和确认机制，所以可靠
        + 只支持全双工
        + 有三类帧：信息帧 监督帧 无编号帧
    + 广播信道
  + 介质访问控制
    + 静态划分信道 信道划分介质访问控制 （把广播信道转换为互不干扰的点对点信道）
      + 频分多路复用FDM 并行 频分复用的所有用户在同样的时间内占用不同的带宽（频率宽带）资源
      + 时分多路复用TDM 并发
        + 统计时分复用STDM 按需动态分配时隙
      + 波分多路复用WDM，就是光的频分多路复用
      + 码分多路复用CDM
    + 动态分配信道
      + 轮询访问介质访问控制
        + 轮询协议 主节点轮流“邀请”从属节点发送数据
        + 令牌传递协议
      + 随机访问介质访问控制 会发送冲突
        + ALOHA协议 不监听信道，不按时间槽发送，随机重发
          + 时隙ALOHA协议
        + CSMA协议 发送帧之前，监听信道
          + 1-坚持CSMA
            + 空闲则直接传输
            + 忙则一直监听，直到空闲马上传输
            + 如果有冲突（一段时间内未收到肯定回复），则等待一个随机长的时间再监听，重复上面过程
          + 非坚持CMSA
            + 空闲则直接传输
            + 忙则等待一个随机的时间之后再进行监听
          + p-坚持CSMA
            + 空闲则以p概率直接传输，不必等待；概率1-p等待下一个时间槽再传输
            + 忙则等待一个随机的时间之后再进行监听
        + CSMA/CD协议 载波监听多点接入/碰撞检测
          + 应用于总线式以太网 半双工通信
          + 截断二进制指数规避算法
            + 基本退避时间为争用期2τ
            + k=min(重传次数，10)
            + 从离散的整数集合{0, 1, ..., 2[k]-1}随机取一个数r，重传需要退避的时间就是r*2τ
            + 重传超过16次仍不成功，则抛弃该帧，并上报错误
          + 最小帧长
            + 帧长（bit）/数据传输速率 >= 2τ
            + 以太网规定最小帧长为64byte
        + CSMA/CA协议 载波监听多点接入/碰撞避免
          + 应用于无线局域网

+ 局域网基本概念和体系结构
  + 局域网拓扑结构
    + 星型拓扑
    + 总线型拓扑
    + 环形拓扑
    + 树型拓扑
  + 局域网介质访问控制
    + CSMA/CD 常用于总线型局域网，也用于树型网络
    + 令牌总线 常用于总线型局域网，也用于树型网络
    + 令牌传递协议
  +  局域网分类
    + 以太网 IEEE802.3 CSMA/CD
      + 只实现无差错接收，不实现可靠传输
      + 逻辑上是总线型，物理上是星型
      + 10BASE-T以太网
        + 传送基带信号，传输速率是10M/s，采用曼切斯特编码
      + MAC地址 48位二进制，前24位表示厂家，后24位厂家自己指定
    + 令牌环网 IEEE802.5
    + FDDI IEEE802.8
    + ATM网
    + 无线局域网 IEEE802.11
  + IEEE802将数据链路层划分为
    + 逻辑链路控制层LLC子层
    + 介质访问控制层MAC子层

+ 数据链路层设备
  + 网桥 根据MAC帧的目的地址对帧进行转发和过滤
    + 透明网桥
    + 源路由网桥
  + 交换机 多接口网桥



以太网MAC帧格式

| 前同步码 | 帧开始定界符 | 目标地址 | 源地址 | 类型 | IP数据报 | FCS  |
| -------- | ------------ | -------- | ------ | ---- | -------- | ---- |
|          |              |          |        |      |          |      |
| 7        | 1            | 6        | 6      | 2    | 46-1500  | 4    |

802.11 WDS 的MAC帧头格式

| 帧控制 | 生存周期ID | 地址1    | 地址2    | 地址3      | 控制序列 | 地址4    |
| ------ | ---------- | -------- | -------- | ---------- | -------- | -------- |
|        |            | RA接收端 | TA发送端 | DA目的地址 |          | SA源地址 |
| 2      | 2          | 6        | 6        | 6          | 2        | 6        |

PPP协议帧格式

| F    | A 地址 | C 保留字段 | 协议 | IP数据报   | FCS  | F    |
| ---- | ------ | ---------- | ---- | ---------- | ---- | ---- |
| 7E   | FF     | 03         |      |            |      | 7E   |
| 1    | 1      | 1          | 2    | 不超过1500 | 2    | 1    |

