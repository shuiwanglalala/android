# 网络层

+ 数据交换方式
  + 电路交换 独占资源
    + 电路交换的过程
      + 建立连接
      + 通信
      + 释放连接
  + 报文交换
    + 报文交换的特点
      + 无需建立连接
      + 存储转发，动态分配线路
      + 多目标服务
  + 分组交换 把大的数据分割成小的数据块
    + 数据报交换 
      + 无连接服务
      + 每个分组携带源和目的地址
      + 路由器根据分组的目的地址转发分组
    + 虚电路交换 
      + 连接服务

+ 路由算法与路由协议
  + 路由算法
    + 按静态和动态分类
      + 静态路由算法
      + 动态路由算法
    + 按全局性和分散性分类
      + 全局性路由算法
        + OSPF
      + 分散性路由算法
        + RIP
  + 路由协议
    + 内部网关协议 IGP
      + RIP与距离向量算法
        + RIP要求网络中每一个路由器单维护从它自己到其他每一个目的网络的唯一最佳距离记录。RIP允许一条路由最多只能包含15个路由器，距离16表示网络不可达
        + 仅和相邻路由器交换信息；路由器交换的信息是自己的路由表；每30s交换一次，超过180s没收到邻居路由器的通告，则判断邻居没了
        + RIP是应用层协议，使用UDP传输数据；一个RIP报文最多可以包括25个路由，如超过，必须再用一个RIP报文传送
        + 好消息传得快，坏信息传得慢，收敛慢
      + OSPF与链路状态算法
        + 使用洪泛法向自治系统内使用路由器发送信息，即路由器通过输出端口向使用相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其使用的相邻路由器
        + 发送的信息就是与本路由器相邻的所有路由器的链路状态（本路由器和哪些路由器相邻，以及该链路的度量--费用/距离/时延/带宽等）
        + 只要当链路状态发生变化时，路由器才向所有路由器洪泛发送此信息
        + QSPF收敛速度很快，直接采用IP
    + 外部网关协议 EGP
      + BGP
        + BGP是应用层协议，借助TCP传送
+ IP地址
  + IP地址=网络号+(子网号+内部主机号)
  + 保留的私有地址 用于内网的服务器地址
    + 10.0.0.0-10.255.255.255 1
    + 172.16.0.0-172.31.255.255 16
    + 192.168.0.0-192.168.255.255 256

+ 网络地址转换NAT 经过路由器时替换地址和端口号
+ 子网划分和子网掩码
  + IP地址和子网掩码做与运算，得到子网的网络号

+ 无分类编制CIDR
  + IP地址=网络前缀+主机号
  + 网络前缀都相同的连续的IP地址组成一个“CIDR地址块”
  + 构成超网/路由聚合 将多个子网聚合成一个较大的子网
    + 使用CIDR时，查找路由表可能得到几个匹配结果，应选择具有最长网络前缀的路由。前缀越长，地址块越小，路由越具体
  + 与A/B/C分类相比，网络前缀可以全0或全1，最大网络数不需要减；但最大主机数仍需要减2

+ ARP协议 
  + 使用过程
    + 检查ARP高速缓存，有对应表则写入MAC帧，没有则用目的MAC地址为FF-FF-FF-FF-FF-FF的帧封装并广播ARP请求分组，同一局域网中所有主机都能收到该请求。目的主机收到请求后就会向源主机单播一个ARP响应分组，源主机收到后就此映射写入ARP缓存中（10-20min更新一次）
  + 4种典型情况
    + 主机A发给本网络主机B，ARP找B的MAC
    + 主机A发给另一网络主机B，ARP找网关MAC
    + 路由器发给本网络主机B，ARP找B的MAC
    + 路由器发给另一网络主机B，ARP找本网络上一个路由器的MAC

+ DHCP协议
  + DHCP是应用层协议，使用客户/服务器方式，客户端和服务端通过广播方式进行交互，基于UDP
  + DHCP提供即插即用联网的机制，主机可以此服务器动态获取IP地址、子网掩码、默认网关、DNS服务器名称和IP地址，允许地址重用，支持移动用户加入网络，支持在用地址虚租
  + 使用过程
    + 主机广播DHCP发现报文
    + DHCP服务器广播DHCP提供报文
    + 主机广播DHCP请求报文
    + DHCP服务器广播DHCP确认报文

+ ICMP协议
  + ICMP差错报告报文 
    + 终点不可达
    + 时间超过 Traceroute
      + TTL=0
      + 在预定时间内不能收到一个数据报的全部数据报片
    + 首部参数问题
    + 改变路由/重定向
  + ICMP询问报文
    + 回送请求和回答报文 PING
    + 时间戳请求和回答报文

+ IPv6
  + 基本地址类型
    + 单播 一对一通信 可做源地址+目的地址
    + 多播 一对多通信 可做目的地址
    + 任播 一对多中的一个通信 可做目的地址

+ IP数据报的传输发送
  + 单播
  + 广播
  + 组播/多播
    + 当网络中的某些用户需要特定数据时，组播数据发送者仅发送一次数据，借助组播路由协议为组播数据包建立组播分发树，被传递的数据到达距离用户端尽可能进的节点才开始复制和分发，是一种点对多点的传输方式
    + 属于多播组的设备将被分配一个组播组IP地址
    + 组播地址范围是D类地址224.0.0.0-239.255.255.255，一个D类地址表示一个组播组，只能用作分组的目的地址，源地址总是单播地址
    + 组播MAC地址以01-00-5E打头，余下24位是根据组播组IP的最后23位映射得到
    + IGMP协议让路由器知道本局域网上是否有主机的进程参加或退出了某个组播组

+ 移动IP

+ 网络层设备

+ 路由汇总 其实就是超网合并子网
  + 默认路由，优先级最低，子网掩码为0.0.0.0
  + 计算机的默认路由就是网关



IPv4数据报

|                            |                         |                    |      |            |                          |                         |      |
| -------------------------- | ----------------------- | ------------------ | ---- | ---------- | ------------------------ | ----------------------- | ---- |
| 版本                       | 首部长度                | 区分服务           |      | 总长度     |                          |                         |      |
| ipv4/ipv6?                 | 单位是4B，最小为5       |                    |      | 首部+数据  | 单位是1B                 |                         |      |
| 标识                       |                         |                    |      | 标志       | 片偏移                   |                         |      |
| 同一数据报的分片的标识一致 |                         |                    |      | 只有3bit   | 某分片在原数据报中的位置 | 单位是8B                |      |
| 生存时间 TTL               |                         | 协议               |      | 首部检验和 |                          |                         |      |
| IP分组的保质期             | 经过一个路由器-1，直至0 | 数据部分使用的协议 |      | 只检验首部 |                          |                         |      |
| 源地址                     |                         |                    |      |            |                          |                         |      |
|                            |                         |                    |      |            |                          |                         |      |
| 目的地址                   |                         |                    |      |            |                          |                         |      |
|                            |                         |                    |      |            |                          |                         |      |
| 可选字段                   |                         |                    |      |            |                          | 填充                    |      |
| 长度可变，0-40B            |                         |                    |      |            |                          | 全0，把首部补成4B整数倍 |      |

IP分类

| 网络类别 | 位数表示 | 范围    | 最大网络数 | 第一个  | 最后一个    | 最大主机数 |
| -------- | -------- | ------- | ---------- | ------- | ----------- | ---------- |
| A        | 0        | 1-126   | 2[7]-2     | 1       | 126         | 2[24]-2    |
| B        | 10       | 128-191 | 2[14]-1    | 128.1   | 191.255     | 2[16]-2    |
| C        | 110      | 192-223 | 2[21]-1    | 192.0.1 | 223.255.255 | 2[8]-2     |
| D        | 1110     | 224-239 |            |         |             |            |
| E        | 1111     | 240-255 |            |         |             |            |

IPv4 vs IPv6

| IPv4                   | IPv6                               |
| ---------------------- | ---------------------------------- |
| 32位                   | 128位                              |
|                        | 移除校验和字段                     |
|                        | 将可选字段移出首部，变成了扩展首部 |
|                        | 支持即插即用，不需要DHCP协议       |
| 首部长度是4B整数倍     | 首部长度是8B整数倍                 |
| 可以在主机和路由处分片 | 只能在主机处分片                   |

子网掩码

| 128      | 192      | 224      | 240      | 248      | 252      | 254      | 255      |
| -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |
| 10000000 | 11000000 | 11100000 | 11110000 | 11111000 | 11111100 | 11111110 | 11111111 |

特殊IP地址

| 网络号 | 主机号            | 作为IP分组源地址 | 作为IP分组目的地址 | 用途                                         |
| ------ | ----------------- | ---------------- | ------------------ | -------------------------------------------- |
| 全0    | 全0               | 可以             | 不可以             | 本网范围内标识主机，路由表中用于表示默认路由 |
| 全0    | 特定值            | 不可以           | 可以               | 表示本网内某个特定主机                       |
| 全1    | 全1               | 不可以           | 可以               | 本网广播地址，路由器不转发                   |
| 特定值 | 全0               | 不可以           | 不可以             | 网络地址，表示一个网络                       |
| 特定值 | 全1               | 不可以           | 可以               | 直接广播地址，对特定网络上的所有主机进行广播 |
| 127    | 任何数（非全0/1） | 可以             | 可以               | 环回地址                                     |

协议对比

|          | RIP                  | OSPF                       | BGP                    |
| -------- | -------------------- | -------------------------- | ---------------------- |
| 类型     | 内部                 | 内部                       | 外部                   |
| 路由算法 | 距离-向量            | 链路状态                   | 路径-向量              |
| 传递协议 | UDP                  | IP                         | TCP                    |
| 路径选择 | 跳数最少             | 代价最低                   | 较好，非最佳           |
| 交换节点 | 和本节点相邻的路由器 | 网络中的使用路由器         | 和本节点相邻的路由器   |
| 交换内容 | 当前本路由器的路由表 | 相邻的所有路由器的链路状态 | 首次交换整个路由表     |
|          |                      |                            | 非首次交换有变化的部分 |

