# 访问共享存储空间中的媒体文件

[Android 10适配要点，作用域存储](https://blog.csdn.net/guolin_blog/article/details/105419420)

[Android 11新特性，Scoped Storage又有了新花样](https://guolin.blog.csdn.net/article/details/113954552)

https://github.com/guolindev/ScopedStorageDemo

https://github.com/android/storage-samples/tree/main/MediaStore

RecoverableSecurityException

https://github.com/android/storage-samples/tree/main/ScopedStorage

google的demo，很好

下载媒体文件和普通文件

saf使用ActivityResultContract



系统会自动扫描外部存储卷，并将媒体文件添加到以下明确定义的集合中

- **图片**（包括照片和屏幕截图），存储在 `DCIM/` 和 `Pictures/` 目录中。系统将这些文件添加到 [`MediaStore.Images`](https://developer.android.com/reference/android/provider/MediaStore.Images?hl=zh-cn) 表格中
- **视频**，存储在 `DCIM/`、`Movies/` 和 `Pictures/` 目录中。系统将这些文件添加到 [`MediaStore.Video`](https://developer.android.com/reference/android/provider/MediaStore.Video?hl=zh-cn) 表格中
- **音频文件**，存储在 `Alarms/`、`Audiobooks/`、`Music/`、`Notifications/`、`Podcasts/` 和 `Ringtones/` 目录中，以及位于 `Music/` 或 `Movies/` 目录中的音频播放列表中。系统将这些文件添加到 [`MediaStore.Audio`](https://developer.android.com/reference/android/provider/MediaStore.Audio?hl=zh-cn) 表格中
- **下载的文件**，存储在 `Download/` 目录中。在搭载 Android 10（API 级别 29）及更高版本的设备上，这些文件存储在 [`MediaStore.Downloads`](https://developer.android.com/reference/android/provider/MediaStore.Downloads?hl=zh-cn) 表格中。此表格在 Android 9（API 级别 28）及更低版本中不可用

媒体库还包含一个名为 [`MediaStore.Files`](https://developer.android.com/reference/android/provider/MediaStore.Files?hl=zh-cn) 的集合。其内容取决于您的应用是否使用[分区存储](https://developer.android.com/training/data-storage?hl=zh-cn#scoped-storage)（适用于以 Android 10 或更高版本为目标平台的应用）

- 如果启用了分区存储，集合只会显示您的应用创建的照片、视频和音频文件
- 如果分区存储不可用或未使用，集合将显示所有类型的媒体文件

## 请求必要权限

### 存储权限

#### 已启用分区存储

如果您的应用使用分区存储，则应仅针对搭载 Android 9（API 级别 28）或更低版本的设备请求存储相关权限。您可以通过将 `android:maxSdkVersion` 属性添加到应用清单文件中的权限声明来应用此条件

**请勿为搭载 Android 10 或更高版本的设备不必要地请求存储相关权限**。您的应用可以提供明确定义的媒体集合，包括 [`MediaStore.Downloads`](https://developer.android.com/reference/android/provider/MediaStore.Downloads?hl=zh-cn) 集合，而无需请求任何存储相关权限

如需访问由其他应用创建的文件，必须满足以下所有条件

- 您的应用已获得 [`READ_EXTERNAL_STORAGE`](https://developer.android.com/reference/android/Manifest.permission#READ_EXTERNAL_STORAGE) 权限
- 这些文件位于以下其中一个明确定义的媒体集合中
  - [`MediaStore.Images`](https://developer.android.com/reference/android/provider/MediaStore.Images)
  - [`MediaStore.Video`](https://developer.android.com/reference/android/provider/MediaStore.Video)
  - [`MediaStore.Audio`](https://developer.android.com/reference/android/provider/MediaStore.Audio)

#### 无法使用分区存储

如果应用在搭载 Android 9 或更低版本的设备上使用，或者应用使用了[存储兼容性功能](https://developer.android.com/training/data-storage/compatibility?hl=zh-cn)，您必须请求 [`READ_EXTERNAL_STORAGE` ](https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#READ_EXTERNAL_STORAGE)权限才能访问媒体文件。如果要修改媒体文件，您还必须请求 [`WRITE_EXTERNAL_STORAGE`](https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#WRITE_EXTERNAL_STORAGE) 权限

### 媒体位置权限

如果应用使用[分区存储](https://developer.android.com/training/data-storage?hl=zh-cn#scoped)，您需要在应用的清单中声明 [`ACCESS_MEDIA_LOCATION`](https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#ACCESS_MEDIA_LOCATION) 权限，然后在运行时请求此权限，应用才能从照片中检索未编辑的 Exif 元数据

## 查询媒体集合

在应用中执行此类查询时，请注意以下几点

- 在工作线程中调用 `query()` 方法
- 缓存列索引，以免每次处理查询结果中的行时都需要调用 [`getColumnIndexOrThrow()`](https://developer.android.com/reference/android/database/Cursor?hl=zh-cn#getColumnIndexOrThrow(java.lang.String))
- 将 ID 附加到内容 URI

## 访问媒体内容时的注意事项

### 媒体共享

如需共享媒体文件，请按照[内容提供程序创建指南](https://developer.android.com/guide/topics/providers/content-provider-creating)中的建议使用 `content://` URI

### 使用原始文件路径的内容访问

如果您没有任何与存储空间相关的权限，您可以访问[应用专属目录](https://developer.android.com/training/data-storage/app-specific)中的文件，并可使用 `File` API 访问[归因于您的应用的媒体文件](https://developer.android.com/training/data-storage/shared/media#app-attribution)。

如果您的应用尝试使用 `File` API 访问文件但没有必要的权限，就会发生 [`FileNotFoundException`](https://developer.android.com/reference/java/io/FileNotFoundException)

如需在搭载 Android 10 的设备上访问共享存储空间中的其他文件，建议您在应用的清单文件中将 [`requestLegacyExternalStorage`](https://developer.android.com/reference/kotlin/android/R.attr?hl=zh-cn#requestLegacyExternalStorage:kotlin.Int) 设置为 `true` 以停用分区存储

### 从原生代码访问内容？？

### 媒体文件的应用归因

当以 Android 10 或更高版本为目标平台的应用启用了[分区存储](https://developer.android.com/training/data-storage?hl=zh-cn#scoped-storage)时，系统会将每个媒体文件归因于一个应用，这决定了应用在未请求任何存储权限时可以访问的文件。每个文件只能归因于一个应用。因此，如果您的应用创建的媒体文件存储在照片、视频或音频文件媒体集合中，应用便可以访问该文件

但是，如果用户卸载并重新安装您的应用，您必须请求 [`READ_EXTERNAL_STORAGE`](https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#READ_EXTERNAL_STORAGE) 才能访问应用最初创建的文件。此权限请求是必需的，因为系统认为文件归因于以前安装的应用版本，而不是新安装的版本

## 添加项目

### 切换媒体文件的待处理状态

如果您的应用执行可能非常耗时的操作（例如写入媒体文件），那么在处理文件时对其进行独占访问非常有用。在搭载 Android 10 或更高版本的设备上，您的应用可以通过将 [`IS_PENDING`](https://developer.android.com/reference/android/provider/MediaStore.MediaColumns?hl=zh-cn#IS_PENDING) 标记的值设为 1 来获取此独占访问权限。如此一来，只有您的应用可以查看该文件，直到您的应用将 `IS_PENDING` 的值改回 0

### 提供文件位置提示

当应用在搭载 Android 10 的设备上存储媒体时，系统默认按照类型对媒体进行整理。例如，新图片文件默认存放在 [`Environment.DIRECTORY_PICTURES`](https://developer.android.com/reference/android/os/Environment?hl=zh-cn#DIRECTORY_PICTURES) 目录中，该目录与 [`MediaStore.Images`](https://developer.android.com/reference/android/provider/MediaStore.Images?hl=zh-cn) 集合相对应

如果应用知道应该存储文件的特定位置，例如名为 Pictures/MyVacationPictures 的相册，您可以设置 [`MediaColumns.RELATIVE_PATH`](https://developer.android.com/reference/android/provider/MediaStore.MediaColumns?hl=zh-cn#RELATIVE_PATH)，为系统提供关于新写入文件存储位置的提示

## 更新项目

您可以在调用 [`update()`](https://developer.android.com/reference/android/content/ContentResolver?hl=zh-cn#update(android.net.Uri,%20android.content.ContentValues,%20java.lang.String,%20java.lang.String[])) 的过程中通过更改 `MediaColumns.RELATIVE_PATH` 或 [`MediaColumns.DISPLAY_NAME`](https://developer.android.com/reference/android/provider/MediaStore.MediaColumns?hl=zh-cn#DISPLAY_NAME) 在磁盘上移动文件

### 更新其他应用的媒体文件

如果您的应用使用[分区存储](https://developer.android.com/training/data-storage?hl=zh-cn#scoped-storage)，它通常无法更新其他应用存放到媒体库中的媒体文件。

不过，您仍可通过捕获平台抛出的 [`RecoverableSecurityException`](https://developer.android.com/reference/android/app/RecoverableSecurityException?hl=zh-cn) 来征得用户同意修改文件。然后，您可以请求用户授予您的应用对此特定内容的写入权限